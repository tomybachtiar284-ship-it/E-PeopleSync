<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Editor - E-PeopleSync</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .editor-container {
            padding: 20px;
        }

        .module-list {
            margin-top: 20px;
        }

        .module-item {
            background: white;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-list {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .question-item {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .option-group {
            margin-left: 20px;
            margin-top: 5px;
        }

        .modal-lg {
            width: 70%;
            margin: 5% auto;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar glass">
            <div class="brand">
                <div class="brand-icon"><img src="../assets/logo.png" alt="Logo"></div>
                <span>E-PeopleSync</span>
            </div>
            <div class="nav-links">
                <div class="nav-label premium">Main</div>
                <a href="../dashboard/index.html" class="nav-link premium"><i class="fas fa-home"></i>
                    <span>Dashboard</span></a>

                <div class="nav-label premium role-restricted">Main Dashboard</div>
                <a href="../admin/index.html" class="nav-link premium role-restricted"><i class="fas fa-th-large"></i>
                    <span>Overview</span></a>

                <div class="nav-label premium role-restricted">Workforce Managed</div>
                <a href="../admin/employees.html" class="nav-link premium role-restricted"><i class="fas fa-users"></i>
                    <span>Employees</span></a>
                <a href="../admin/attendance.html" class="nav-link premium role-restricted"><i
                        class="fas fa-calendar-check"></i>
                    <span>Attendance & Shifts</span></a>
                <a href="../evaluation/index.html" class="nav-link premium"><i class="fas fa-chart-line"></i>
                    <span>Performance</span></a>

                <div class="nav-label premium role-restricted">Finance & Talent</div>
                <a href="../admin/payroll.html" class="nav-link premium role-restricted"><i
                        class="fas fa-money-bill-wave"></i>
                    <span>Payroll & Claims</span></a>
                <a href="../recruitment/index.html" class="nav-link premium"><i class="fas fa-user-plus"></i>
                    <span>Recruitment</span></a>
                <a href="index.html" class="nav-link premium active"><i class="fas fa-graduation-cap"></i>
                    <span>Learning Hub</span></a>

                <div class="nav-label premium role-restricted">Communication</div>
                <a href="../admin/news.html" class="nav-link premium role-restricted"><i class="fas fa-newspaper"></i>
                    <span>Company News</span></a>

                <div class="nav-label premium role-restricted">Enterprise Tools</div>
                <a href="../admin/assets.html" class="nav-link premium role-restricted"><i class="fas fa-boxes"></i>
                    <span>Asset Management</span></a>
                <a href="../admin/documents.html" class="nav-link premium role-restricted"><i
                        class="fas fa-file-contract"></i>
                    <span>Document Center</span></a>
                <a href="../admin/org_chart.html" class="nav-link premium role-restricted"><i
                        class="fas fa-sitemap"></i>
                    <span>Org Chart</span></a>

                <div class="nav-label premium role-restricted" style="margin-top: 20px;">Settings</div>
                <a href="../admin/settings.html" class="nav-link premium role-restricted"><i class="fas fa-cog"></i>
                    <span>Administration</span></a>
                <br>
            </div>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" onclick="logout()" class="nav-link premium text-danger"><i
                        class="fas fa-sign-out-alt"></i>
                    <span>Logout</span></a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div class="d-flex align-items-center">
                    <a href="index.html" class="btn btn-sm btn-secondary mr-3"><i class="fas fa-arrow-left"></i>
                        Back</a>
                    <h2 id="courseTitle">Loading Course...</h2>
                    <button class="btn btn-sm btn-outline-primary ml-3" onclick="openCourseSettings()">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <h4 id="userName">User</h4>
                    </div>
                </div>
            </header>

            <div class="content-area editor-container">
                <!-- Tabs -->
                <div class="tabs mb-3">
                    <button class="tab-btn active" onclick="switchTab('modules')">Modules & Quizzes</button>
                    <button class="tab-btn" onclick="switchTab('submissions')">Student Submissions</button>
                </div>

                <!-- Module Tab -->
                <div id="modulesTab">
                    <div class="card mb-4">
                        <h3>Course Modules & Quizzes</h3>
                        <p class="text-muted">Manage the content and assessments for this course.</p>
                        <div id="moduleList" class="module-list">
                            <!-- Modules will be loaded here -->
                        </div>
                        <button class="btn btn-primary mt-3" onclick="addModule()"><i class="fas fa-plus"></i> Add
                            Module</button>
                        <button class="btn btn-secondary mt-3" onclick="addQuiz()"><i class="fas fa-pencil-alt"></i> Add
                            Quiz</button>
                    </div>
                </div>

                <!-- Submissions Tab -->
                <div id="submissionsTab" style="display:none;">
                    <div class="card mb-4">
                        <h3>Student Submissions</h3>
                        <p class="text-muted">Review and grade student quiz attempts.</p>
                        <div id="submissionList">
                            <!-- Submissions loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- Module Editor Modal -->
    <div id="moduleModal" class="modal"
        style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
        <div class="modal-content"
            style="background-color:#fff; margin:10% auto; padding:20px; border-radius:8px; width: 50%;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="moduleModalTitle">Edit Module</h3>
                <span class="close" onclick="closeModuleModal()" style="font-size:24px; cursor:pointer;">&times;</span>
            </div>
            <form id="moduleForm">
                <input type="hidden" id="editModuleId">
                <div class="form-group">
                    <label>Module Title</label>
                    <input type="text" id="modTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="modType" class="form-control" onchange="toggleModuleType()">
                        <option value="video">Video</option>
                        <option value="text">Text / Article</option>
                        <option value="pdf">PDF Document</option>
                    </select>
                </div>
                <div class="form-group" id="modUrlGroup">
                    <label>Video/Document URL</label>
                    <input type="text" id="modUrl" class="form-control" placeholder="https://youtube.com/...">
                </div>
                <div class="form-group" id="modContentGroup" style="display:none;">
                    <label>Text Content</label>
                    <textarea id="modContent" class="form-control" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label>Duration (e.g. "5 min")</label>
                    <input type="text" id="modDuration" class="form-control" required>
                </div>
                <div class="text-right mt-4">
                    <button type="button" class="btn btn-danger mr-auto" onclick="deleteModule()"
                        id="btnDeleteModule">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModuleModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Module</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quiz Creation Modal -->
    <div id="quizModal" class="modal"
        style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
        <div class="modal-content"
            style="background-color:#fff; margin:10% auto; padding:20px; border-radius:8px; width: 40%;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 id="quizModalTitle">Create New Quiz</h3>
                <span class="close" onclick="closeQuizModal()" style="font-size:24px; cursor:pointer;">&times;</span>
            </div>
            <form id="quizForm">
                <div class="form-group">
                    <label>Quiz Title</label>
                    <input type="text" id="newQuizTitle" class="form-control" required
                        placeholder="e.g., Final Assessment">
                </div>
                <div class="form-group">
                    <label>Passing Score (%)</label>
                    <input type="number" id="newQuizPassScore" class="form-control" required value="70">
                </div>
                <div class="text-right mt-4">
                    <button type="button" class="btn btn-secondary" onclick="closeQuizModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Quiz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quiz Settings Modal (Existing) -->
    <div id="quizSettingsModal" class="modal" ...>
        <!-- Note: This was placeholder in previous view_file, checking if it exists -->
        <!-- Question Editor Modal -->
        <div id="questionModal" class="modal"
            style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
            <div class="modal-content modal-lg"
                style="background-color:#fff; padding:20px; border-radius:8px; width: 80%; max-width: 900px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Manage Questions</h3>
                    <span class="close" onclick="closeQuestionModal()"
                        style="font-size:24px; cursor:pointer;">&times;</span>
                </div>

                <div class="row mb-4 p-3 bg-light rounded shadow-sm border" style="margin: 0 0 20px 0;">
                    <div class="col-md-6">
                        <label class="font-weight-bold">Quiz Title</label>
                        <input type="text" id="quizTitleInput" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="font-weight-bold">Passing Score (%)</label>
                        <input type="number" id="quizPassScoreInput" class="form-control">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-secondary btn-block" onclick="saveQuizSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4" style="border-right: 1px solid #eee;">
                        <h5>Questions</h5>
                        <div id="existingQuestions" style="max-height: 400px; overflow-y: auto;">
                            <!-- JS Populated -->
                        </div>
                        <button class="btn btn-sm btn-success btn-block mt-3" onclick="showAddQuestionForm()">+ Add New
                            Question</button>
                    </div>
                    <div class="col-md-8">
                        <div id="emptyState" class="text-center p-5 text-muted">
                            <i class="fas fa-arrow-left"></i> Select a question to edit or click "Add New"
                        </div>

                        <div id="questionFormContainer" style="display: none;">
                            <h4 id="formTitle" class="mb-3">Edit Question</h4>
                            <form id="questionForm">
                                <input type="hidden" id="editQuestionId">

                                <div class="form-group">
                                    <label>Question Type</label>
                                    <select id="questionType" class="form-control" onchange="toggleQuestionType()">
                                        <option value="multiple-choice">Multiple Choice</option>
                                        <option value="essay">Essay / Long Answer</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Question Text</label>
                                    <textarea id="questionText" class="form-control" rows="3" required></textarea>
                                </div>

                                <!-- Multiple Choice Options -->
                                <div id="multipleChoiceOptions">
                                    <label>Options (Select correct answer)</label>
                                    <div id="optionsContainer">
                                        <!-- JS Populated -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addOption()">+
                                        Add
                                        Option</button>
                                </div>

                                <!-- Essay Options -->
                                <div id="essayOptions" style="display: none;">
                                    <div class="form-group">
                                        <label>Keywords for Auto-Grading (Optional)</label>
                                        <input type="text" id="questionKeywords" class="form-control"
                                            placeholder="comma, separated, keywords">
                                        <small class="text-muted">If student answer contains these words, they get
                                            points
                                            (hybrid grading).</small>
                                    </div>
                                </div>

                                <div class="text-right mt-4">
                                    <button type="button" class="btn btn-secondary"
                                        onclick="hideQuestionForm()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Question</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grading Modal -->
        <div id="gradingModal" class="modal"
            style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
            <div class="modal-content modal-lg" style="background-color:#fff; padding:20px; border-radius:8px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Grade Submission</h3>
                    <span class="close" onclick="closeGradingModal()"
                        style="font-size:24px; cursor:pointer;">&times;</span>
                </div>
                <div id="gradingContent"></div>
            </div>
        </div>

        <!-- Course Settings Modal -->
        <div id="courseSettingsModal" class="modal"
            style="display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);">
            <div class="modal-content"
                style="background-color:#fff; margin:10% auto; padding:20px; border-radius:8px; width: 50%;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Edit Course Settings</h3>
                    <span class="close" onclick="closeCourseSettings()"
                        style="font-size:24px; cursor:pointer;">&times;</span>
                </div>
                <form id="courseSettingsForm">
                    <div class="form-group">
                        <label>Course Title</label>
                        <input type="text" id="editCourseTitle" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editCourseDesc" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="editCourseCategory" class="form-control">
                            <!-- JS populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Difficulty Level</label>
                        <select id="editCourseLevel" class="form-control">
                            <!-- JS populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Thumbnail URL</label>
                        <input type="text" id="editCourseThumbnail" class="form-control">
                        <small class="text-muted">Or upload new image (future feature)</small>
                    </div>
                    <div class="text-right mt-4 d-flex justify-content-between">
                        <button type="button" class="btn btn-danger" onclick="deleteCourse()">Delete Course</button>
                        <div>
                            <button type="button" class="btn btn-secondary"
                                onclick="closeCourseSettings()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script src="../js/utils.js"></script>
        <script src="../js/api.js"></script>
        <script>
            let currentCourseId = null;
            let currentQuizId = null;
            let editingQuiz = null;
            let editingModuleId = null;
            let currentAttemptId = null;

            document.addEventListener('DOMContentLoaded', () => {
                const user = checkAuth(['admin', 'manager']);
                if (user) document.getElementById('userName').textContent = user.name;

                const urlParams = new URLSearchParams(window.location.search);
                currentCourseId = parseInt(urlParams.get('id'));

                if (!currentCourseId) {
                    alert('Invalid Course ID');
                    window.location.href = 'index.html';
                    return;
                }

                loadCourseData();
            });

            async function loadCourseData() {
                try {
                    const courses = await API.getCourses();
                    const course = courses.find(c => c.id === currentCourseId);

                    if (!course) {
                        alert('Course not found');
                        window.location.href = 'index.html';
                        return;
                    }

                    document.getElementById('courseTitle').textContent = `Editing: ${course.title}`;

                    const [modules, quizzes] = await Promise.all([
                        API.getCourseModules(currentCourseId),
                        API.getQuizzes({ courseId: currentCourseId })
                    ]);

                    renderModules(modules, quizzes);
                } catch (err) {
                    console.error('Error loading course data:', err);
                    alert('Failed to load course data');
                }
            }

            function renderModules(modules, quizzes) {
                const list = document.getElementById('moduleList');
                list.innerHTML = '';

                // Modules
                modules.forEach(mod => {
                    let icon = 'fa-file-alt';
                    if (mod.type === 'video') icon = 'fa-file-video';
                    else if (mod.type === 'pdf') icon = 'fa-file-pdf';

                    list.innerHTML += `
                    <div class="module-item">
                        <div>
                            <strong><i class="fas ${icon} text-primary"></i> ${mod.title}</strong>
                            <div class="text-muted small">${mod.type.toUpperCase()} - ${mod.duration}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="openModuleEditor(${mod.id})">Edit</button>
                    </div>
                `;
                });

                // Quizzes
                quizzes.forEach(quiz => {
                    const questionCount = quiz.questions ? quiz.questions.length : 0;
                    list.innerHTML += `
                    <div class="module-item" style="border-left: 4px solid #fbc02d;">
                        <div>
                            <strong><i class="fas fa-question-circle text-warning"></i> ${quiz.title}</strong>
                            <div class="text-muted small">${questionCount} Questions - Pass Score: ${quiz.passing_score || quiz.passingScore}</div>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="openQuizEditor(${quiz.id})">Manage Questions</button>
                    </div>
                `;
                });
            }

            // --- Module Editor Logic ---
            function addModule() {
                openModuleEditor(null);
            }

            async function openModuleEditor(moduleId) {
                editingModuleId = moduleId;
                const modal = document.getElementById('moduleModal');
                const title = document.getElementById('moduleModalTitle');
                const form = document.getElementById('moduleForm');
                const btnDelete = document.getElementById('btnDeleteModule');

                modal.style.display = 'block';
                form.reset();

                if (moduleId) {
                    try {
                        const modules = await API.getCourseModules(currentCourseId);
                        const module = modules.find(m => m.id === moduleId);
                        title.textContent = "Edit Module";
                        document.getElementById('editModuleId').value = module.id;
                        document.getElementById('modTitle').value = module.title;
                        document.getElementById('modType').value = module.type;
                        document.getElementById('modDuration').value = module.duration;

                        if (module.type === 'video' || module.type === 'pdf') {
                            document.getElementById('modUrl').value = module.url || '';
                        } else {
                            document.getElementById('modContent').value = module.content || '';
                        }

                        toggleModuleType();
                        btnDelete.style.display = 'inline-block';
                    } catch (err) {
                        console.error('Error fetching module:', err);
                    }
                } else {
                    // Add Mode
                    title.textContent = "Add New Module";
                    document.getElementById('editModuleId').value = '';
                    toggleModuleType();
                    btnDelete.style.display = 'none';
                }
            }

            function closeModuleModal() {
                document.getElementById('moduleModal').style.display = 'none';
            }

            function toggleModuleType() {
                const type = document.getElementById('modType').value;
                if (type === 'text') {
                    document.getElementById('modUrlGroup').style.display = 'none';
                    document.getElementById('modContentGroup').style.display = 'block';
                } else {
                    document.getElementById('modUrlGroup').style.display = 'block';
                    document.getElementById('modContentGroup').style.display = 'none';
                }
            }

            document.getElementById('moduleForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('editModuleId').value;
                const title = document.getElementById('modTitle').value;
                const type = document.getElementById('modType').value;
                const duration = document.getElementById('modDuration').value;
                const url = document.getElementById('modUrl').value;
                const content = document.getElementById('modContent').value;

                try {
                    if (id) {
                        await API.updateCourseModule(id, {
                            title, type, duration,
                            url: type !== 'text' ? url : null,
                            content: type === 'text' ? content : null,
                            sort_order: 0 // Default
                        });
                    } else {
                        await API.addCourseModule(currentCourseId, {
                            title, type, duration,
                            url: type !== 'text' ? url : null,
                            content: type === 'text' ? content : null,
                            sort_order: 0
                        });
                    }

                    alert('Module Saved!');
                    closeModuleModal();
                    loadCourseData();
                } catch (err) {
                    console.error('Error saving module:', err);
                    alert('Failed to save module');
                }
            });

            async function deleteModule() {
                if (editingModuleId && confirm('Delete this module?')) {
                    try {
                        await API.deleteCourseModule(editingModuleId);
                        closeModuleModal();
                        loadCourseData();
                        alert('Module deleted successfully');
                    } catch (err) {
                        console.error('Error deleting module:', err);
                        alert('Failed to delete module');
                    }
                }
            }

            // --- Quiz Editor Logic ---

            async function openQuizEditor(quizId) {
                try {
                    currentQuizId = quizId;
                    const quizzes = await API.getQuizzes({ courseId: currentCourseId });
                    editingQuiz = quizzes.find(q => q.id === quizId);

                    document.getElementById('questionModal').style.display = 'block';

                    // Populate Settings
                    document.getElementById('quizTitleInput').value = editingQuiz.title;
                    document.getElementById('quizPassScoreInput').value = editingQuiz.passing_score || editingQuiz.passingScore;

                    renderQuestionList();
                    hideQuestionForm();
                } catch (err) {
                    console.error('Error opening quiz editor:', err);
                }
            }

            async function saveQuizSettings() {
                const title = document.getElementById('quizTitleInput').value;
                const score = parseInt(document.getElementById('quizPassScoreInput').value);

                if (!title || isNaN(score)) {
                    alert('Please enter valid Title and Pass Score');
                    return;
                }

                try {
                    editingQuiz.title = title;
                    editingQuiz.passing_score = score;
                    delete editingQuiz.passingScore; // Clean up old key if exists

                    await API.updateQuiz(editingQuiz.id, {
                        title: title,
                        questions: editingQuiz.questions,
                        passing_score: score
                    });
                    alert('Quiz Settings Updated!');
                } catch (err) {
                    console.error('Error saving quiz settings:', err);
                    alert('Failed to update quiz settings');
                }
            }

            function closeQuestionModal() {
                document.getElementById('questionModal').style.display = 'none';
                loadCourseData(); // Refresh main view to show updated question count
            }

            function renderQuestionList() {
                const container = document.getElementById('existingQuestions');
                container.innerHTML = '';

                editingQuiz.questions.forEach((q, index) => {
                    const typeLabel = q.type === 'essay' ? '<span class="badge badge-info">Essay</span>' : '<span class="badge badge-success">MC</span>';
                    container.innerHTML += `
                    <div class="question-item" style="cursor:pointer;" onclick="editQuestion(${index})">
                        <div class="d-flex justify-content-between">
                            <small>Question ${index + 1}</small>
                            ${typeLabel}
                        </div>
                        <div style="font-weight:500; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${q.text}</div>
                    </div>
                `;
                });
            }

            function showAddQuestionForm() {
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('questionFormContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Add New Question';
                document.getElementById('questionForm').reset();
                document.getElementById('editQuestionId').value = -1; // New

                // Reset options
                document.getElementById('optionsContainer').innerHTML = '';
                addOption('Option 1');
                addOption('Option 2');
                toggleQuestionType();
            }

            function hideQuestionForm() {
                document.getElementById('questionFormContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }

            function toggleQuestionType() {
                const type = document.getElementById('questionType').value;
                const mcContainer = document.getElementById('multipleChoiceOptions');
                const essayContainer = document.getElementById('essayOptions');

                if (type === 'multiple-choice') {
                    mcContainer.style.display = 'block';
                    essayContainer.style.display = 'none';
                } else {
                    mcContainer.style.display = 'none';
                    essayContainer.style.display = 'block';
                }
            }

            function addOption(value = '', isCorrect = false) {
                const container = document.getElementById('optionsContainer');
                const index = container.children.length;

                const div = document.createElement('div');
                div.className = 'input-group mb-2 d-flex align-items-center';
                div.innerHTML = `
                <input type="radio" name="correctAnswer" value="${index}" ${isCorrect ? 'checked' : ''} style="margin-right:10px;">
                <input type="text" class="form-control option-input" value="${value}" placeholder="Option ${index + 1}" required>
                <button type="button" class="btn btn-sm btn-danger ml-2" onclick="removeOption(this)">&times;</button>
            `;
                container.appendChild(div);

                // Update radio values
                updateRadioValues();
            }

            function removeOption(btn) {
                btn.parentElement.remove();
                updateRadioValues();
            }

            function updateRadioValues() {
                const radios = document.querySelectorAll('input[name="correctAnswer"]');
                radios.forEach((radio, index) => {
                    radio.value = index;
                });
            }

            function editQuestion(index) {
                const q = editingQuiz.questions[index];
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('questionFormContainer').style.display = 'block';
                document.getElementById('formTitle').textContent = 'Edit Question ' + (index + 1);
                document.getElementById('editQuestionId').value = index;

                document.getElementById('questionType').value = q.type || 'multiple-choice';
                document.getElementById('questionText').value = q.text;

                if (q.type === 'essay') {
                    document.getElementById('questionKeywords').value = q.keywords ? q.keywords.join(', ') : '';
                } else {
                    const container = document.getElementById('optionsContainer');
                    container.innerHTML = '';
                    q.options.forEach((opt, i) => {
                        addOption(opt, i === q.answer);
                    });
                }

                toggleQuestionType();
            }

            document.getElementById('questionForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const index = parseInt(document.getElementById('editQuestionId').value);
                const type = document.getElementById('questionType').value;
                const text = document.getElementById('questionText').value;

                let newQuestion = {
                    id: Date.now(),
                    type: type,
                    text: text
                };

                if (type === 'multiple-choice') {
                    const optionInputs = document.querySelectorAll('.option-input');
                    const options = Array.from(optionInputs).map(input => input.value);
                    const correctRadio = document.querySelector('input[name="correctAnswer"]:checked');

                    if (!correctRadio) {
                        alert('Please select a correct answer for multiple choice questions.');
                        return;
                    }

                    newQuestion.options = options;
                    newQuestion.answer = parseInt(correctRadio.value);
                } else if (type === 'essay') {
                    const keywords = document.getElementById('questionKeywords').value;
                    newQuestion.keywords = keywords ? keywords.split(',').map(k => k.trim()) : [];
                }

                try {
                    if (index === -1) {
                        // Add new
                        editingQuiz.questions.push(newQuestion);
                    } else {
                        // Update existing
                        newQuestion.id = editingQuiz.questions[index].id;
                        editingQuiz.questions[index] = newQuestion;
                    }

                    await API.updateQuiz(editingQuiz.id, {
                        title: editingQuiz.title,
                        questions: editingQuiz.questions,
                        passing_score: editingQuiz.passing_score || editingQuiz.passingScore
                    });

                    renderQuestionList();
                    hideQuestionForm();
                    alert('Question saved!');
                } catch (err) {
                    console.error('Error saving question:', err);
                    alert('Failed to save question');
                }
            });

            // Add Quiz Logic
            function addQuiz() {
                document.getElementById('quizModal').style.display = 'block';
                document.getElementById('quizForm').reset();
            }

            function closeQuizModal() {
                document.getElementById('quizModal').style.display = 'none';
            }

            document.getElementById('quizForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('newQuizTitle').value;
                const passing_score = parseInt(document.getElementById('newQuizPassScore').value);

                try {
                    await API.createQuiz({
                        course_id: currentCourseId,
                        title,
                        passing_score,
                        questions: []
                    });
                    alert('Quiz created successfully!');
                    closeQuizModal();
                    loadCourseData();
                } catch (err) {
                    console.error('Error creating quiz:', err);
                    alert('Failed to create quiz');
                }
            });

            // Tab Switching
            function switchTab(tabName) {
                document.getElementById('modulesTab').style.display = tabName === 'modules' ? 'block' : 'none';
                document.getElementById('submissionsTab').style.display = tabName === 'submissions' ? 'block' : 'none';

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                if (tabName === 'modules') document.querySelector('.tab-btn:first-child').classList.add('active');
                else {
                    document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                    loadSubmissions();
                }
            }

            // --- Course Settings Logic ---
            async function openCourseSettings() {
                try {
                    const [courses, settings] = await Promise.all([
                        API.getCourses(),
                        API.getSettings()
                    ]);
                    const course = courses.find(c => c.id === currentCourseId);

                    if (!course) return;

                    // Populate Dropdowns
                    populateDropdown('editCourseCategory', settings.courseCategories || ['Onboarding', 'Skill'], 'Category');
                    populateDropdown('editCourseLevel', settings.courseLevels || ['Foundation', 'Practitioner', 'Specialist', 'Mastery'], 'Level');

                    // Populate Fields
                    document.getElementById('editCourseTitle').value = course.title;
                    document.getElementById('editCourseDesc').value = course.description || '';
                    document.getElementById('editCourseCategory').value = course.category || '';
                    document.getElementById('editCourseLevel').value = course.level || 'Foundation';
                    document.getElementById('editCourseThumbnail').value = course.thumbnail || '';

                    document.getElementById('courseSettingsModal').style.display = 'block';
                } catch (err) {
                    console.error('Error opening course settings:', err);
                }
            }

            function closeCourseSettings() {
                document.getElementById('courseSettingsModal').style.display = 'none';
            }

            document.getElementById('courseSettingsForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const title = document.getElementById('editCourseTitle').value;
                const desc = document.getElementById('editCourseDesc').value;
                const cat = document.getElementById('editCourseCategory').value;
                const level = document.getElementById('editCourseLevel').value;
                const thumb = document.getElementById('editCourseThumbnail').value;

                try {
                    await API.updateCourse(currentCourseId, {
                        title: title,
                        description: desc,
                        category: cat,
                        level: level,
                        thumbnail: thumb
                    });

                    alert('Course Settings Updated!');
                    closeCourseSettings();
                    loadCourseData();
                } catch (err) {
                    console.error('Error updating course settings:', err);
                    alert('Failed to update course settings');
                }
            });

            async function deleteCourse() {
                if (!confirm('Are you sure you want to delete this course? This action cannot be undone and will remove all modules, quizzes, and student enrollments associated with it.')) {
                    return;
                }

                try {
                    await API.deleteCourse(currentCourseId);
                    alert('Course deleted successfully.');
                    window.location.href = 'index.html';
                } catch (err) {
                    console.error('Error deleting course:', err);
                    alert('Failed to delete course');
                }
            }

            // --- Grading Logic ---
            async function loadSubmissions() {
                try {
                    // Get quizzes for this course
                    const quizzes = await API.getQuizzes({ courseId: currentCourseId });
                    const courseQuizIds = quizzes.map(q => q.id);

                    if (courseQuizIds.length === 0) {
                        document.getElementById('submissionList').innerHTML = '<p class="text-muted">No quizzes created for this course yet.</p>';
                        return;
                    }

                    // Get all attempts for these quizzes
                    const attemptsPromises = courseQuizIds.map(qid => API.getQuizAttempts({ quizId: qid }));
                    const attemptsResults = await Promise.all(attemptsPromises);
                    const attempts = attemptsResults.flat();

                    const list = document.getElementById('submissionList');
                    list.innerHTML = '';

                    if (attempts.length === 0) {
                        list.innerHTML = '<p class="text-muted">No submissions yet.</p>';
                        return;
                    }

                    // Get all users and quizzes for mapping
                    const [users, allQuizzes] = await Promise.all([
                        API.getEmployees(),
                        API.getQuizzes()
                    ]);

                    attempts.forEach(attempt => {
                        const user = users.find(u => u.id === attempt.user_id || u.id === attempt.userId);
                        const quiz = allQuizzes.find(q => q.id === attempt.quiz_id || q.id === attempt.quizId);
                        const status = attempt.status || 'graded';
                        const badge = status === 'graded' ? '<span class="badge badge-success">Graded</span>' : '<span class="badge badge-warning">Pending Review</span>';
                        const score = attempt.score !== null ? parseFloat(attempt.score).toFixed(0) : '0';

                        list.innerHTML += `
                        <div class="module-item">
                            <div>
                                <strong>${user ? user.name : 'Unknown User'}</strong> - ${quiz ? quiz.title : 'Unknown Quiz'}
                                <br>
                                <small class="text-muted">Date: ${new Date(attempt.attempted_at || attempt.date).toLocaleDateString()}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                ${badge}
                                <span class="ml-3 font-weight-bold" style="margin-right:15px; font-size:16px;">${score}</span>
                                <button class="btn btn-sm btn-primary" onclick="openGradingModal(${attempt.id})">Grade</button>
                            </div>
                        </div>
                    `;
                    });
                } catch (err) {
                    console.error('Error loading submissions:', err);
                    document.getElementById('submissionList').innerHTML = '<p class="text-danger">Failed to load submissions from database.</p>';
                }
            }



            async function openGradingModal(attemptId) {
                try {
                    currentAttemptId = attemptId;
                    const attempts = await API.getQuizAttempts({ id: attemptId }); // Filter by ID if supported, or fetch and find
                    const attempt = attempts.find(a => a.id === attemptId);

                    if (!attempt) throw new Error(`Submission #${attemptId} not found in database.`);

                    const quizRes = await API.getQuizzes({ id: attempt.quiz_id || attempt.quizId });
                    const quiz = quizRes[0];
                    if (!quiz) throw new Error(`Quiz associated with this submission is missing.`);

                    const users = await API.getEmployees();
                    const user = users.find(u => u.id === attempt.user_id || u.id === attempt.userId);

                    const content = document.getElementById('gradingContent');
                    const userName = user ? user.name : 'Unknown User (Deleted)';
                    let html = `<h5>Student: ${userName}</h5><hr>`;

                    let answers = typeof attempt.answers === 'string' ? JSON.parse(attempt.answers) : attempt.answers;

                    // Robustness: Handle legacy object format { "qid": "ans" }
                    if (answers && !Array.isArray(answers) && typeof answers === 'object') {
                        console.warn('Legacy answer format detected for attempt', attemptId);
                        answers = Object.keys(answers).map(qid => ({
                            questionId: parseInt(qid),
                            answer: answers[qid],
                            score: 0,
                            maxScore: 10, // Default for legacy
                            type: 'essay' // Default to essay for manual review if unknown
                        }));
                    }

                    if (!Array.isArray(answers)) answers = [];

                    if (answers.length === 0) {
                        html += '<p>No answers recorded for this attempt.</p>';
                        content.innerHTML = html;
                        document.getElementById('gradingModal').style.display = 'block';
                        return;
                    }

                    answers.forEach((ans, index) => {
                        const q = quiz.questions ? quiz.questions.find(quest => quest.id === ans.questionId) : null;

                        if (!q) {
                            html += `
                            <div class="mb-4 p-3 bg-light border rounded">
                                <p class="text-danger">Question deleted or not found.</p>
                                <p class="text-muted">Recorded Answer: ${ans.answer}</p>
                            </div>
                        `;
                            return;
                        }

                        const isEssay = q.type === 'essay' || ans.type === 'essay';

                        html += `
                        <div class="mb-4 p-3" style="background:${isEssay ? '#fff3e0' : '#f9f9f9'}; border-radius:5px;">
                            <p><strong>Q${index + 1}: ${q.text}</strong></p>
                            <p class="text-muted">Student Answer:</p>
                            <div class="p-2 border rounded bg-white mb-2">
                                ${isEssay ? ans.answer : (q.options && q.options[ans.answer] ? q.options[ans.answer] : ans.answer)}
                            </div>
                    `;

                        if (isEssay) {
                            const keywordsHtml = q.keywords && q.keywords.length > 0
                                ? q.keywords.map(k => `<span class="badge badge-secondary mr-1">${k}</span>`).join('')
                                : '<span class="text-muted font-italic">No keywords defined</span>';

                            html += `
                            <div class="d-flex align-items-center mb-2">
                                 <small class="mr-2">Keywords:</small> 
                                 ${keywordsHtml}
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Score (Max ${ans.maxScore})</label>
                                <div class="col-sm-8">
                                    <input type="number" class="form-control score-input" data-qid="${ans.questionId}" value="${ans.score}" max="${ans.maxScore}">
                                </div>
                            </div>
                        `;
                        } else {
                            html += `<p class="small ${ans.score > 0 ? 'text-success' : 'text-danger'}">Auto-Score: ${ans.score}/${ans.maxScore}</p>`;
                        }

                        html += `</div>`;
                    });

                    html += `<button class="btn btn-success btn-block mt-3" onclick="saveGrade()">Finalize & Save Grade</button>`;
                    content.innerHTML = html;

                    document.getElementById('gradingModal').style.display = 'block';
                } catch (error) {
                    console.error('Grading Error:', error);
                    alert('Sistem mengalami masalah: ' + error.message);
                }
            }

            function closeGradingModal() {
                document.getElementById('gradingModal').style.display = 'none';
            }

            async function saveGrade() {
                try {
                    const attempts = await API.getQuizAttempts({ id: currentAttemptId });
                    const attempt = attempts[0];
                    if (!attempt) throw new Error('Attempt not found.');

                    const answers = typeof attempt.answers === 'string' ? JSON.parse(attempt.answers) : attempt.answers;

                    const inputs = document.querySelectorAll('.score-input');
                    let totalEarned = 0;
                    let totalMax = 0;

                    // Update scores from inputs
                    inputs.forEach(input => {
                        const qId = parseInt(input.dataset.qid);
                        const newScore = parseFloat(input.value);
                        const ansIndex = answers.findIndex(a => a.questionId === qId);
                        if (ansIndex > -1) {
                            answers[ansIndex].score = newScore;
                        }
                    });

                    // Recalculate Total
                    answers.forEach(a => {
                        totalEarned += parseFloat(a.score);
                        totalMax += parseFloat(a.maxScore);
                    });

                    const finalScore = (totalEarned / totalMax) * 100;

                    const quizRes = await API.getQuizzes({ id: attempt.quiz_id || attempt.quizId });
                    const quiz = quizRes[0];

                    await API.updateQuizAttempt(currentAttemptId, {
                        score: finalScore,
                        passed: finalScore >= (quiz.passing_score || 70),
                        answers: answers,
                        status: 'graded'
                    });

                    // If passed, update enrollment
                    await checkCourseCompletion(attempt.user_id || attempt.userId, quiz.course_id, finalScore, quiz.passing_score || 70);

                    closeGradingModal();
                    loadSubmissions();
                    alert('Grade updated successfully!');
                } catch (err) {
                    console.error('Error saving grade:', err);
                    alert('Failed to save grade: ' + (err.error || err.message || 'Unknown error'));
                }
            }

            async function checkCourseCompletion(userId, courseId, score, passingScore) {
                if (score >= passingScore) {
                    try {
                        const enrollments = await API.getEnrollments({ userId, courseId });
                        let enrollment = enrollments[0];

                        if (!enrollment) {
                            enrollment = await API.enroll({
                                user_id: userId,
                                course_id: courseId
                            });
                        }

                        const compDate = new Date().toISOString().split('T')[0];
                        await API.updateEnrollment(enrollment.id, {
                            progress: 100,
                            status: 'completed',
                            completed_at: compDate
                        });

                        // Handle Certificate (Simplified for now, similar to learning.js)
                        const settings = await API.getSettings();
                        const certificates = settings.certificates || [];
                        const courses = await API.getCourses();
                        const course = courses.find(c => c.id === courseId);

                        const existingCert = certificates.find(c => c.userId === userId && c.courseName === course.title);

                        if (!existingCert) {
                            const certCode = `CERT-${new Date().getFullYear()}-${Date.now().toString().slice(-4)}`;
                            certificates.push({
                                id: Date.now(),
                                userId: userId,
                                courseName: course.title,
                                date: compDate,
                                code: certCode
                            });

                            await API.saveSetting('certificates', certificates);
                        }

                        console.log('Course marked as completed and certificate generated.');
                    } catch (err) {
                        console.error('Error in course completion:', err);
                    }
                }
            }
        </script>
</body>

</html>
</body>

</html>