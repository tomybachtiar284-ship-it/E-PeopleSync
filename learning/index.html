<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Hub - E-PeopleSync</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar glass">
            <div class="brand">
                <div class="brand-icon"><img src="../assets/logo.png" alt="Logo"></div>
                <span>E-PeopleSync</span>
            </div>
            <div class="nav-links">
                <div class="nav-label premium">Main</div>
                <a href="../dashboard/index.html" class="nav-link premium"><i class="fas fa-home"></i>
                    <span>Dashboard</span></a>
                <a href="../dashboard/approvers.html" class="nav-link premium"><i class="fas fa-user-tie"></i>
                    <span>Approvers</span></a>

                <div class="nav-label premium role-restricted">Main Dashboard</div>
                <a href="../admin/index.html" class="nav-link premium role-restricted"><i class="fas fa-th-large"></i>
                    <span>Overview</span></a>

                <div class="nav-label premium role-restricted">Workforce Managed</div>
                <a href="../admin/employees.html" class="nav-link premium role-restricted"><i class="fas fa-users"></i>
                    <span>Employees</span></a>
                <a href="../admin/attendance.html" class="nav-link premium role-restricted"><i
                        class="fas fa-calendar-check"></i>
                    <span>Attendance & Shifts</span></a>
                <a href="../evaluation/index.html" class="nav-link premium"><i class="fas fa-chart-line"></i>
                    <span>Performance</span></a>

                <div class="nav-label premium role-restricted">Finance & Talent</div>
                <a href="../admin/payroll.html" class="nav-link premium role-restricted"><i
                        class="fas fa-money-bill-wave"></i>
                    <span>Payroll & Claims</span></a>
                <a href="../recruitment/index.html" class="nav-link premium role-restricted"><i
                        class="fas fa-user-plus"></i>
                    <span>Recruitment</span></a>
                <a href="index.html" class="nav-link premium"><i class="fas fa-graduation-cap"></i>
                    <span>Learning Hub</span></a>

                <div class="nav-label premium role-restricted">Communication</div>
                <a href="../admin/news.html" class="nav-link premium role-restricted"><i class="fas fa-newspaper"></i>
                    <span>Company News</span></a>

                <div class="nav-label premium role-restricted">Enterprise Tools</div>
                <a href="../admin/assets.html" class="nav-link premium role-restricted"><i class="fas fa-boxes"></i>
                    <span>Asset Management</span></a>
                <a href="../admin/documents.html" class="nav-link premium role-restricted"><i
                        class="fas fa-file-contract"></i>
                    <span>Document Center</span></a>
                <a href="../admin/org_chart.html" class="nav-link premium role-restricted"><i
                        class="fas fa-sitemap"></i>
                    <span>Org Chart</span></a>


                <div class="nav-label premium role-restricted" style="margin-top: 20px;">Settings</div>
                <a href="../admin/settings.html" class="nav-link premium role-restricted"><i class="fas fa-cog"></i>
                    <span>Administration</span></a>
                <br>
            </div>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" onclick="logout()" class="nav-link premium text-danger"><i
                        class="fas fa-sign-out-alt"></i>
                    <span>Logout</span></a>
            </div>
        </aside>

        <main class="main-content">
            <!-- Header rendered dynamically via renderModernHeader() -->

            <div class="content-area">
                <!-- Admin Analytics (Hidden by default) -->
                <div class="grid-3 mb-4" id="adminAnalytics" style="display: none;">
                    <div class="card stat-card">
                        <div class="stat-header"><span>Total Courses</span></div>
                        <div class="stat-value" id="statTotalCourses">0</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header"><span>Active Learners</span></div>
                        <div class="stat-value" id="statActiveLearners">0</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header"><span>Certificates Issued</span></div>
                        <div class="stat-value" id="statCertificates">0</div>
                    </div>
                </div>

                <!-- Admin Monitoring Panel (Detailed View) -->
                <div class="card mb-4" id="adminMonitoring" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 style="margin:0;"><i class="fas fa-user-check text-primary mr-2"></i> Student Completion
                            Monitor</h3>
                        <div class="small text-muted">Real-time data from PostgreSQL</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #eee;">
                                    <th style="padding: 12px; text-align: left;">Student Name</th>
                                    <th style="padding: 12px; text-align: left;">Course Title</th>
                                    <th style="padding: 12px; text-align: left;">Status</th>
                                    <th style="padding: 12px; text-align: left;">Score</th>
                                    <th style="padding: 12px; text-align: left;">Completed Date</th>
                                </tr>
                            </thead>
                            <tbody id="monitoringTableBody">
                                <tr>
                                    <td colspan="5" style="text-align:center; padding:20px; color:#999;">Loading
                                        monitoring data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2>Learning Hub</h2>
                        <p style="color: #666;">Expand your knowledge and master new competencies.</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" id="btnCreateCourse" style="display: none;"
                            onclick="openCourseModal()">+ Create Course</button>
                    </div>
                </div>

                <!-- Create Course Modal -->
                <div id="createCourseModal" class="modal"
                    style="display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4);">
                    <div class="modal-content"
                        style="background-color:#fefefe; margin:15% auto; padding:20px; border:1px solid #888; width:50%; border-radius:8px;">
                        <span class="close" onclick="closeCourseModal()"
                            style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
                        <h2>Create New Course</h2>
                        <form id="createCourseForm" class="mt-4">
                            <div class="form-group">
                                <label>Course Title</label>
                                <input type="text" id="courseTitle" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="courseDesc" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <select id="courseCategory" class="form-control">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Difficulty Level</label>
                                <select id="courseLevel" class="form-control">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Course Image (JPG/PNG)</label>
                                <input type="file" id="courseImage" class="form-control" accept="image/jpeg, image/png">
                                <small class="text-muted">Max recommended size: 500KB</small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Create Course</button>
                        </form>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="d-flex justify-content-between align-items-center mb-4 pb-2"
                    style="border-bottom: 1px solid #eee;">
                    <!-- Left: Status Tabs -->
                    <div class="tabs">
                        <button class="tab-btn active" onclick="filterCourses('all')">All Courses</button>
                        <button class="tab-btn" onclick="filterCourses('progress')">In Progress</button>
                        <button class="tab-btn" onclick="filterCourses('completed')">Completed</button>
                    </div>

                    <!-- Right: Level Filter -->
                    <div class="d-flex align-items-center">
                        <label for="filterLevel" class="mr-2 mb-0"
                            style="font-size: 14px; color: #666; font-weight: 500;">Difficulty:</label>
                        <select id="filterLevel" class="form-control"
                            style="width: 160px; height: auto; padding: 8px 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px; cursor: pointer; background-color: #fff;"
                            onchange="filterCourses(document.querySelector('.tab-btn.active').getAttribute('onclick').match(/'(.*)'/)[1])">
                            <option value="">All Levels</option>
                            <option value="Foundation">Foundation</option>
                            <option value="Practitioner">Practitioner</option>
                            <option value="Specialist">Specialist</option>
                            <option value="Mastery">Mastery</option>
                        </select>
                    </div>
                </div>

                <!-- Course Grid -->
                <div class="grid-3" id="courseGrid">
                    <!-- JS will populate this -->
                </div>
            </div>
            <!-- Footer rendered dynamically via renderModernFooter() -->
        </main>
    </div>

    <script>
    </script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Use API object from api.js
        // const API = 'http://localhost:3001'; // Removed local definition

        // Initialize
        document.addEventListener('DOMContentLoaded', async function () {
            updateSidebarForRole();
            const user = checkAuth(['employee', 'manager', 'admin', 'candidate']);
            if (!user) return;

            initUserProfile();

            try {
                // Fetch Base Data using centralized API client
                const [courses, enrollments, settings] = await Promise.all([
                    API.getCourses(),
                    API.getEnrollments(),
                    API.getSettings()
                ]);
                const certificates = settings.certificates || [];

                // Admin Features
                if (user.role === 'admin') {
                    document.getElementById('btnCreateCourse').style.display = 'block';
                    document.getElementById('adminAnalytics').style.display = 'grid';

                    // Populate Analytics (Live API Data)
                    document.getElementById('statTotalCourses').textContent = courses.length;
                    document.getElementById('statActiveLearners').textContent = enrollments.length;
                    document.getElementById('statCertificates').textContent = certificates.length;

                    // Show & Load Monitoring Panel
                    document.getElementById('adminMonitoring').style.display = 'block';
                    loadAdminMonitoring(courses, enrollments);
                }

                // Render with fetched data
                renderCourses(courses, enrollments, user);

            } catch (err) {
                console.error('Initial Load Error:', err);
                renderCourses([], [], user);
            }
        });

        // Modal Logic
        async function openCourseModal() {
            try {
                const settings = await API.getSettings();
                populateDropdown('courseCategory', settings.course_categories || ['Onboarding', 'Skill'], 'Category');
                populateDropdown('courseLevel', settings.course_levels || ['Foundation', 'Practitioner', 'Specialist', 'Mastery'], 'Level');
                document.getElementById('createCourseModal').style.display = 'block';
            } catch (err) {
                console.error('Failed to load settings:', err);
                populateDropdown('courseCategory', ['Onboarding', 'Skill'], 'Category');
                populateDropdown('courseLevel', ['Foundation', 'Practitioner', 'Specialist', 'Mastery'], 'Level');
                document.getElementById('createCourseModal').style.display = 'block';
            }
        }
        function closeCourseModal() { document.getElementById('createCourseModal').style.display = 'none'; }

        // Create Course Logic
        document.getElementById('createCourseForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const title = document.getElementById('courseTitle').value;
            const desc = document.getElementById('courseDesc').value;
            const cat = document.getElementById('courseCategory').value;
            const level = document.getElementById('courseLevel').value;
            const fileInput = document.getElementById('courseImage');
            const file = fileInput.files[0];

            async function submitCourse(imgData = '') {
                try {
                    const res = await API.createCourse({
                        title,
                        description: desc,
                        category: cat,
                        level,
                        thumbnail: imgData || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80'
                    });

                    if (res) {
                        alert('Course created successfully!');
                        closeCourseModal();
                        window.location.reload();
                    } else {
                        throw new Error('Failed to create course');
                    }
                } catch (err) {
                    console.error('Error creating course:', err);
                    alert('Gagal membuat kursus. Silakan coba lagi.');
                }
            }

            if (file) {
                const reader = new FileReader();
                reader.onload = e => submitCourse(e.target.result);
                reader.readAsDataURL(file);
            } else {
                submitCourse();
            }
        });

        async function renderCourses(providedCourses, providedEnrollments, user, filter = 'all') {
            const grid = document.getElementById('courseGrid');
            const levelFilter = document.getElementById('filterLevel').value;

            let courses = providedCourses;
            let enrollments = providedEnrollments;

            if (!courses || !enrollments) {
                try {
                    [courses, enrollments] = await Promise.all([
                        API.getCourses(),
                        API.getEnrollments({ userId: user.id })
                    ]);
                } catch (err) {
                    console.error('Render Courses Fetch Error:', err);
                    grid.innerHTML = '<p class="text-center col-12">Failed to load courses from server.</p>';
                    return;
                }
            }

            // 1. Filter by Status (Tab)
            if (filter === 'progress') {
                courses = courses.filter(c => {
                    const e = enrollments.find(en => (en.course_id === c.id || en.courseId === c.id) && (en.user_id === user.id || en.userId === user.id));
                    return e && e.status === 'in-progress';
                });
            } else if (filter === 'completed') {
                courses = courses.filter(c => {
                    const e = enrollments.find(en => (en.course_id === c.id || en.courseId === c.id) && (en.user_id === user.id || en.userId === user.id));
                    return e && e.status === 'completed';
                });
            }

            // 2. Filter by Level (Dropdown)
            if (levelFilter) {
                courses = courses.filter(c => c.level === levelFilter);
            }

            if (courses.length === 0) {
                grid.innerHTML = '<p class="text-center col-12">No courses found matching criteria.</p>';
                return;
            }

            grid.innerHTML = '';

            // For extra details (attempts), we fetch them for current user
            const attempts = await API.getQuizAttempts({ userId: user.id });

            courses.forEach(course => {
                const enrollment = enrollments.find(e => (e.course_id === course.id || e.courseId === course.id) && (e.user_id === user.id || e.userId === user.id));
                const courseAttempts = attempts.filter(a => a.course_id === course.id || a.courseId === course.id || a.quiz_id === course.id); // Loose matching for flexibility
                const latestAttempt = courseAttempts.sort((a, b) => b.id - a.id)[0];

                let progress = enrollment ? enrollment.progress : 0;
                let btnText = 'Start Course';
                let btnClass = 'btn-primary';

                if (!enrollment && (user.role === 'admin' || user.role === 'manager')) {
                    btnText = 'Preview Course';
                    btnClass = 'btn-outline-primary';
                }

                let statusBadge = '';

                if (enrollment) {
                    if (enrollment.status === 'completed') {
                        btnText = 'Review Course';
                        btnClass = 'btn-success';
                        progress = 100;
                    } else if (enrollment.status === 'submitted') {
                        btnText = 'Pending Review';
                        btnClass = 'btn-warning';
                        statusBadge = '<span class="badge badge-warning" style="font-size:10px; margin-left:5px;">In Review</span>';
                    } else if (latestAttempt && latestAttempt.score < 70) { // Simple threshold check
                        btnText = 'Retake Quiz';
                        btnClass = 'btn-danger';
                        statusBadge = '<span class="badge badge-danger" style="font-size:10px; margin-left:5px;">Failed</span>';
                    } else {
                        btnText = 'Continue Learning';
                        btnClass = 'btn-primary';
                    }
                }

                let editBtn = '';
                if (user.role === 'admin') {
                    editBtn = `<a href="course_editor.html?id=${course.id}" class="btn btn-sm btn-secondary" style="background:#6c757d; color:white; text-align:center; padding:8px; text-decoration:none; border-radius:6px; width: 40px; display: flex; align-items: center; justify-content: center;" title="Manage Course"><i class="fas fa-edit"></i></a>`;
                }

                const levelColor = course.level === 'Practitioner' ? '#17a2b8' : (course.level === 'Specialist' ? '#ffc107' : (course.level === 'Mastery' ? '#dc3545' : '#888'));

                grid.innerHTML += `
                    <div class="course-card">
                        <div class="course-img" style="background-image: url('${course.thumbnail}')">
                            <span class="course-tag">${course.category || 'General'}</span>
                            <span class="course-tag" style="left: auto; right: 10px; background-color:${levelColor}">${course.level || 'Foundation'}</span>
                        </div>
                        <div class="course-body">
                            <h4 style="margin-bottom:5px; font-weight:600;">${course.title}</h4>
                            <p style="font-size:13px; color:#666; margin-bottom:15px; line-height:1.4;">${course.description || 'Master this new competency.'}</p>
                            <div class="d-flex justify-content-between" style="font-size:11px; font-weight:600; margin-bottom:5px;">
                                <span>YOUR PROGRESS ${statusBadge}</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-bar" style="height:4px; background:#e0f2f1; width:100%; border-radius:2px; margin-bottom:15px;">
                                <div style="width:${progress}%; background:var(--primary-color); height:100%; border-radius:2px;"></div>
                            </div>
                            <div class="d-flex" style="gap: 5px;">
                                <a href="course.html?id=${course.id}" class="btn btn-sm btn-block ${btnClass}" style="color:white; text-align:center; padding:8px; text-decoration:none; border-radius:6px; flex: 1;">${btnText}</a>
                                ${editBtn}
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function filterCourses(status) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick').includes(`'${status}'`)) tab.classList.add('active');
            });
            const user = JSON.parse(localStorage.getItem('currentUser'));
            renderCourses(null, null, user, status);
        }

        async function loadAdminMonitoring(allCourses, allEnrollments) {
            try {
                const [users, attempts] = await Promise.all([
                    API.getEmployees(),
                    API.getQuizAttempts()
                ]);

                const completedEnrollments = allEnrollments.filter(e => e.status === 'completed');
                const tbody = document.getElementById('monitoringTableBody');
                tbody.innerHTML = '';

                if (completedEnrollments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No completions recorded yet.</td></tr>';
                    return;
                }

                // Sort by completed_at desc
                completedEnrollments.sort((a, b) => new Date(b.completed_at || 0) - new Date(a.completed_at || 0));

                completedEnrollments.forEach(en => {
                    const user = users.find(u => u.id === en.user_id || u.id === en.userId);
                    const course = allCourses.find(c => c.id === en.course_id || c.id === en.courseId);

                    // Match score from attempts
                    const userAttempts = attempts.filter(a =>
                        (a.user_id === en.user_id || a.userId === en.userId) &&
                        (a.quiz_id === en.course_id || a.quizId === en.courseId)
                    );
                    const maxScore = userAttempts.length > 0 ? Math.max(...userAttempts.map(a => parseFloat(a.score))) : 'N/A';

                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #eee';
                    row.innerHTML = `
                        <td style="padding: 12px;"><strong>${user ? user.name : 'Unknown'}</strong></td>
                        <td style="padding: 12px;">${course ? course.title : 'Deleted Course'}</td>
                        <td style="padding: 12px;"><span class="badge badge-success">Completed</span></td>
                        <td style="padding: 12px; font-weight:bold;">${maxScore !== 'N/A' ? parseFloat(maxScore).toFixed(0) : '0'}</td>
                        <td style="padding: 12px; color:#666;">${en.completed_at ? new Date(en.completed_at).toLocaleDateString('id-ID') : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error('Monitoring Load Error:', err);
                document.getElementById('monitoringTableBody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">Gagal memuat data monitoring.</td></tr>';
            }
        }
    </script>
</body>

</html>