<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance - E-PeopleSync</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="dashboard-layout">
        <aside class="sidebar glass">
            <div class="brand">
                <div class="brand-icon"><img src="../assets/logo.png" alt="Logo"></div>
                <span>E-PeopleSync</span>
            </div>
            <div class="nav-links">
                <div class="nav-label premium">Main</div>
                <a href="../dashboard/index.html" class="nav-link premium"><i class="fas fa-home"></i>
                    <span>Dashboard</span></a>
                <a href="../dashboard/approvers.html" class="nav-link premium"><i class="fas fa-user-tie"></i>
                    <span>Approvers</span></a>

                <div class="nav-label premium role-restricted">Main Dashboard</div>
                <a href="../admin/index.html" class="nav-link premium role-restricted"><i class="fas fa-th-large"></i>
                    <span>Overview</span></a>

                <div class="nav-label premium role-restricted">Workforce Managed</div>
                <a href="../admin/employees.html" class="nav-link premium role-restricted"><i class="fas fa-users"></i>
                    <span>Employees</span></a>
                <a href="../admin/attendance.html" class="nav-link premium role-restricted"><i
                        class="fas fa-calendar-check"></i>
                    <span>Attendance & Shifts</span></a>
                <a href="index.html" class="nav-link premium"><i class="fas fa-chart-line"></i>
                    <span>Performance</span></a>

                <div class="nav-label premium role-restricted">Finance & Talent</div>
                <a href="../admin/payroll.html" class="nav-link premium role-restricted"><i
                        class="fas fa-money-bill-wave"></i>
                    <span>Payroll & Claims</span></a>
                <a href="../recruitment/index.html" class="nav-link premium role-restricted"><i
                        class="fas fa-user-plus"></i>
                    <span>Recruitment</span></a>
                <a href="../learning/index.html" class="nav-link premium"><i class="fas fa-graduation-cap"></i>
                    <span>Learning Hub</span></a>

                <div class="nav-label premium role-restricted">Communication</div>
                <a href="../admin/news.html" class="nav-link premium role-restricted"><i class="fas fa-newspaper"></i>
                    <span>Company News</span></a>

                <div class="nav-label premium role-restricted">Enterprise Tools</div>
                <a href="../admin/assets.html" class="nav-link premium role-restricted"><i class="fas fa-boxes"></i>
                    <span>Asset Management</span></a>
                <a href="../admin/documents.html" class="nav-link premium role-restricted"><i
                        class="fas fa-file-contract"></i>
                    <span>Document Center</span></a>
                <a href="../admin/org_chart.html" class="nav-link premium role-restricted"><i
                        class="fas fa-sitemap"></i>
                    <span>Org Chart</span></a>


                <div class="nav-label premium role-restricted" style="margin-top: 20px;">Settings</div>
                <a href="../admin/settings.html" class="nav-link premium role-restricted"><i class="fas fa-cog"></i>
                    <span>Administration</span></a>
                <br>
            </div>
            <div class="sidebar-footer">
                <a href="javascript:void(0)" onclick="logout()" class="nav-link premium text-danger"><i
                        class="fas fa-sign-out-alt"></i>
                    <span>Logout</span></a>
            </div>
        </aside>

        <main class="main-content">
            <!-- Header rendered dynamically via renderModernHeader() -->

            <div class="content-area">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2>Performance Tracker</h2>
                        <p style="color: #666;" id="pageSubtitle">Monitor your professional growth and competency
                            evaluations.</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-emerald" id="btnManageEval" style="display:none;"
                            onclick="openEvalModal()">
                            <i class="fas fa-plus-circle"></i> Beri Penilaian Karyawan
                        </button>
                        <button class="btn btn-primary" onclick="generateAISummary()"><i class="fas fa-magic"></i>
                            Generate AI Summary</button>
                    </div>
                </div>

                <!-- Admin Management Section (Hidden by Default) -->
                <div id="adminManagementSection" class="glass-card mb-4"
                    style="display:none; padding: 20px; border-left: 5px solid #10b981;">
                    <h3 style="font-size: 16px; margin-bottom:15px;"><i class="fas fa-users-cog"></i> Management Panel
                    </h3>
                    <div class="d-flex align-items-center gap-3">
                        <p style="margin:0; font-size:14px; color:#555;">Pilih karyawan untuk melihat atau memberi
                            penilaian baru:</p>
                        <select id="employeeSelector" class="form-control" style="max-width:300px;"
                            onchange="loadEmployeePerf(this.value)">
                            <option value="">-- Pilih Karyawan --</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <!-- Radar Chart -->
                    <div class="card">
                        <h3>Competency Radar</h3>
                        <p style="color:#888; font-size:13px;">Visual breakdown of skill areas</p>
                        <canvas id="radarChart"></canvas>
                    </div>

                    <!-- History Line Chart -->
                    <div class="card">
                        <h3>KPI Score History</h3>
                        <p style="color:#888; font-size:13px;">Quarterly performance trend (1.0 - 5.0)</p>
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>

                <div class="grid-2 mt-4">
                    <!-- Current Objectives -->
                    <div class="card">
                        <h3>Current Objectives</h3>
                        <div class="mt-3">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span style="font-weight:500">Migrate legacy Auth to OAuth2</span>
                                    <span class="badge-status badge-green">On Track</span>
                                </div>
                                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;">
                                    <div style="width:75%; background:#00796b; height:100%;"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span style="font-weight:500">Reduce API Latency by 20%</span>
                                    <span class="badge-status badge-red">Warning</span>
                                </div>
                                <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;">
                                    <div style="width:40%; background:#e53935; height:100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manager Feedback -->
                    <div class="card">
                        <h3>Manager Feedback</h3>
                        <div
                            style="background:#fff3e0; padding:15px; border-radius:8px; display:flex; gap:10px; margin-top:15px;">
                            <i class="fas fa-exclamation-circle" style="color:#ef6c00; margin-top:3px;"></i>
                            <div>
                                <h4 style="font-size:14px; margin-bottom:5px;">Monthly One-on-One</h4>
                                <p style="font-size:13px; color:#555; line-height:1.4;">
                                    "Great work on the last sprint. Let's focus on the documentation quality for the
                                    next release."
                                </p>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Oct 14, 2024 • By Sarah Admin
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer rendered dynamically via renderModernFooter() -->
        </main>
    </div>

    <!-- Evaluation Modal -->
    <div id="evalModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px; padding: 30px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 style="margin: 0; color: var(--premium-navy);">Beri Penilaian Performa</h3>
                <span style="cursor:pointer; font-size: 24px;" onclick="closeEvalModal()">&times;</span>
            </div>
            <form id="evalForm">
                <div class="grid-2 gap-3 mb-4">
                    <div>
                        <label class="d-block font-weight-700 mb-2">Karyawan</label>
                        <select id="evalEmployeeId" class="form-control" required></select>
                    </div>
                    <div>
                        <label class="d-block font-weight-700 mb-2">Skor Akhir KPI (1 - 5.0)</label>
                        <input type="number" id="evalKpiScore" class="form-control" step="0.1" min="1" max="5"
                            value="4.0" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="d-block font-weight-700 mb-2">Skor Kompetensi Radar (0 - 100)</label>
                    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                        <div><small>Technical</small><input type="number" id="r_tech" class="form-control" value="80"
                                required></div>
                        <div><small>Comm.</small><input type="number" id="r_comm" class="form-control" value="80"
                                required></div>
                        <div><small>Leaders.</small><input type="number" id="r_lead" class="form-control" value="80"
                                required></div>
                        <div><small>Prod.</small><input type="number" id="r_prod" class="form-control" value="80"
                                required></div>
                        <div><small>Innov.</small><input type="number" id="r_innov" class="form-control" value="80"
                                required></div>
                        <div><small>Teamw.</small><input type="number" id="r_team" class="form-control" value="80"
                                required></div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="d-block font-weight-700 mb-2">Feedback / Masukan Manajer</label>
                    <textarea id="evalFeedback" class="form-control" rows="3" required
                        placeholder="Tulis masukan untuk karyawan..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100 p-3" style="border-radius:12px;">Simpan
                    Penilaian</button>
            </form>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .font-weight-700 {
            font-weight: 700;
            font-size: 13px;
            color: #4a5568;
        }

        .btn-emerald {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
        }

        .gap-2 {
            gap: 10px;
        }

        .gap-3 {
            gap: 15px;
        }
    </style>

    <script src="../js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const user = checkAuth(['admin', 'manager', 'employee']);
            if (!user) return;

            renderModernHeader();
            renderModernFooter();

            let myEval = null;
            const targetId = viewAs || user.id;

            try {
                const response = await fetch(`http://localhost:3001/api/evaluations?userId=${targetId}`);
                const evals = await response.json();
                if (evals && evals.length > 0) {
                    myEval = evals[0]; // Get the newest evaluation

                    // Parse JSON strings back to arrays if they are strings
                    if (typeof myEval.radar_data === 'string') myEval.radar_data = JSON.parse(myEval.radar_data);
                    if (typeof myEval.history_data === 'string') myEval.history_data = JSON.parse(myEval.history_data);
                    if (typeof myEval.objectives === 'string') myEval.objectives = JSON.parse(myEval.objectives);
                }
            } catch (error) {
                console.error('Error fetching evaluations:', error);
            }

            // Default fallback if no evaluation found
            const radarValues = myEval && myEval.radar_data ? myEval.radar_data : [60, 60, 60, 60, 60, 60];
            const historyValues = myEval && myEval.history_data ? myEval.history_data : [3.0, 3.0, 3.0, 3.0, 3.0, 3.0];

            // Render Objective Cards dynamically
            if (myEval && myEval.objectives && myEval.objectives.length > 0) {
                const objectivesDiv = document.querySelectorAll('.card')[2].querySelector('.mt-3'); // Current Objectives is 3rd card
                objectivesDiv.innerHTML = myEval.objectives.map(obj => `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span style="font-weight:500">${obj.title}</span>
                            <span class="badge-status ${obj.status === 'On Track' ? 'badge-green' : (obj.status === 'Complete' ? 'badge-green' : 'badge-red')}">${obj.status}</span>
                        </div>
                        <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;">
                            <div style="width:${obj.progress}%; background:${obj.color}; height:100%;"></div>
                        </div>
                    </div>
                `).join('');
            }

            // Render Feedback dynamically
            if (myEval && myEval.feedback_message) {
                const feedbackDiv = document.querySelectorAll('.card')[3]; // Manager Feedback is 4th card
                feedbackDiv.innerHTML = `
                    <h3>Manager Feedback</h3>
                    <div style="background:#fff3e0; padding:15px; border-radius:8px; display:flex; gap:10px; margin-top:15px;">
                        <i class="fas fa-exclamation-circle" style="color:#ef6c00; margin-top:3px;"></i>
                        <div>
                            <h4 style="font-size:14px; margin-bottom:5px;">Performance Review</h4>
                            <p style="font-size:13px; color:#555; line-height:1.4;">"${myEval.feedback_message}"</p>
                            <div style="font-size:11px; color:#888; margin-top:5px;">${new Date(myEval.feedback_date).toLocaleDateString()} • By ${myEval.feedback_by || 'Manager'}</div>
                        </div>
                    </div>
                `;
            }

            // Radar Chart
            new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: ['Technical', 'Communication', 'Leadership', 'Productivity', 'Innovation', 'Teamwork'],
                    datasets: [{
                        label: 'Current Skills',
                        data: radarValues,
                        fill: true,
                        backgroundColor: 'rgba(52, 79, 161, 0.2)', // Modified to match premium-navy/blue
                        borderColor: '#344fa1',
                        pointBackgroundColor: '#344fa1',
                    }]
                },
                options: { elements: { line: { borderWidth: 3 } } }
            });

            // History Chart
            window._historyChart = new Chart(document.getElementById('historyChart'), {
                type: 'line',
                data: {
                    labels: ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'KPI Score',
                        data: historyValues,
                        borderColor: '#344fa1',
                        tension: 0.4,
                        pointRadius: 4
                    }]
                },
                options: {
                    scales: { y: { min: 0, max: 5 } },
                    plugins: { legend: { display: false } }
                }
            });

            // --- ADMIN LOGIC ---
            if (['admin', 'manager'].includes(user.role)) {
                document.getElementById('btnManageEval').style.display = 'block';
                document.getElementById('adminManagementSection').style.display = 'block';
                document.getElementById('pageSubtitle').textContent = 'Panel Manajemen Performa: Berikan penilaian dan tinjau hasil kerja karyawan.';

                // Populate Employee Selectors
                const employees = await API.getEmployees();
                const selectors = ['employeeSelector', 'evalEmployeeId'];
                selectors.forEach(sId => {
                    const el = document.getElementById(sId);
                    employees.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.id;
                        opt.textContent = `${emp.name} (${emp.position || emp.role})`;
                        el.appendChild(opt);
                    });
                });
            }
        });

        async function loadEmployeePerf(empId) {
            if (!empId) return;
            // Fetch selected employee data and update charts
            try {
                const response = await fetch(`http://localhost:3001/api/evaluations?userId=${empId}`);
                const evals = await response.json();
                const myEval = (evals && evals.length > 0) ? evals[0] : null;

                const r_data = (myEval && myEval.radar_data) ? (typeof myEval.radar_data === 'string' ? JSON.parse(myEval.radar_data) : myEval.radar_data) : [60, 60, 60, 60, 60, 60];
                const h_data = (myEval && myEval.history_data) ? (typeof myEval.history_data === 'string' ? JSON.parse(myEval.history_data) : myEval.history_data) : [3, 3, 3, 3, 3, 3];

                // Update charts via global references or re-init
                // For simplicity here, alert and update briefly or re-render
                location.href = `index.html?viewAs=${empId}`;
            } catch (e) { console.error(e); }
        }

        // Check if viewing as another user (Admin feature)
        const urlParams = new URLSearchParams(window.location.search);
        const viewAs = urlParams.get('viewAs');
        if (viewAs) {
            // Modify initial fetch to use viewAs
            // (Handled by adjusting the DOMContentLoaded fetch slightly if we wanted, 
            // but for now let's focus on the INPUT FORM)
        }

        function openEvalModal() { document.getElementById('evalModal').style.display = 'flex'; }
        function closeEvalModal() { document.getElementById('evalModal').style.display = 'none'; }

        document.getElementById('evalForm')?.addEventListener('submit', async function (e) {
            e.preventDefault();
            const admin = JSON.parse(localStorage.getItem('currentUser'));
            const payload = {
                user_id: document.getElementById('evalEmployeeId').value,
                kpi_score: document.getElementById('evalKpiScore').value,
                radar_data: [
                    parseInt(document.getElementById('r_tech').value),
                    parseInt(document.getElementById('r_comm').value),
                    parseInt(document.getElementById('r_lead').value),
                    parseInt(document.getElementById('r_prod').value),
                    parseInt(document.getElementById('r_innov').value),
                    parseInt(document.getElementById('r_team').value)
                ],
                history_data: [3.5, 3.7, 3.8, 3.9, 4.0, parseFloat(document.getElementById('evalKpiScore').value)],
                objectives: [
                    { title: 'Project Delivery', status: 'On Track', progress: 80, color: '#10b981' },
                    { title: 'Team Collaboration', status: 'On Track', progress: 70, color: '#3b82f6' }
                ],
                feedback_message: document.getElementById('evalFeedback').value,
                feedback_by: admin.name,
                feedback_date: new Date().toISOString()
            };

            try {
                await API.createEvaluation(payload);
                alert('Penilaian berhasil disimpan!');
                closeEvalModal();
                location.reload();
            } catch (err) {
                alert('Gagal menyimpan penilaian');
                console.error(err);
            }
        });

        async function generateAISummary() {
            const btn = document.querySelector('button[onclick="generateAISummary()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Genkit Analyzing...';

            // Dynamic import
            const { aiPerformanceReviewSummary } = await import('../js/ai_flows.js');

            const result = await aiPerformanceReviewSummary(user.name, {});

            const container = document.getElementById('aiSummaryContainer');
            container.innerHTML = `
                <div class="card" style="border-left: 4px solid var(--primary-color); animation: fadeIn 0.5s;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3><i class="fas fa-magic" style="color:var(--primary-color)"></i> Genkit Performance Review</h3>
                        <span class="badge badge-success">Generated by Gemini 1.5</span>
                    </div>
                    <p style="margin-top:10px; font-size:1.1em; line-height:1.6;">"${result.narrative}"</p>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:20px;">
                        <div style="background:#e0f2f1; padding:15px; border-radius:8px;">
                            <strong style="color:#00695c; display:block; margin-bottom:5px;">TOP STRENGTH</strong>
                            <i class="fas fa-arrow-up" style="color:#00695c"></i> ${result.structured.strength}
                        </div>
                        <div style="background:#ffebee; padding:15px; border-radius:8px;">
                            <strong style="color:#c62828; display:block; margin-bottom:5px;">DEVELOPMENT AREA</strong>
                            <i class="fas fa-exclamation-circle" style="color:#c62828"></i> ${result.structured.area}
                        </div>
                    </div>
                </div>
            `;

            btn.innerHTML = '<i class="fas fa-magic"></i> Regenerate AI Summary';
        }
    </script>
</body>

</html>